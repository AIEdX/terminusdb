#!/usr/bin/env swipl

:- initialization(main).

:- use_module(library(process)).
:- use_module(library(optparse)).
:- use_module(library(md5)).

opt_spec([[opt(help),
           type(boolean),
           shortflags([h]),
           longflags([help]), 
           default(false),
           help('print this help')],
          
          [opt(key),
           type(atom),
           shortflags([k]),
           longflags([key]),
           default(admin),
           help('key of amin user')]]).

/* 
 * help(+Cmd:atom,-Help:atom) is det.
 */
help(Cmd,Spec,Help) :-
    file_base_name(Cmd,Name),
    opt_help(Spec,Help_Text),
    format(atom(Help),'Usage: ~s [OPTIONS]

Set the administrative key - necessary before superuser can begin to set other permissions

~s', [Name,Help_Text]).

example_ttl(Dir,Path) :- 
    atomic_list_concat([Dir,'/../config/capability_instance_template.ttl'], Path).

instance_ttl(Dir,Path) :- 
    atomic_list_concat([Dir,'/../storage/http%3a%2f%2flocalhost%2fcapability/main/1/1-ckp.ttl'], Path).

instance_hdt(Dir,Path) :- 
    atomic_list_concat([Dir,'/../storage/http%3a%2f%2flocalhost%2fcapability/main/1/1-ckp.hdt'], Path).

program(Prog) :-
    current_prolog_flag(associated_file,Prog).
    
main(Args) :-
    (   command(rdf2hdt)    
    ->  true
    ;   format('We can\'t proceed without rdf2hdt but it\'s not installed.  Aborting.\n')),

    program(Prog),
    opt_spec(Spec),
    opt_parse(Spec,Args,Opts,_),
    help(Prog,Spec,Help_Text),
    
    (   memberchk(help(true), Opts)
    ->  write(Help_Text),
        halt
    ;   memberchk(key(admin), Opts)
    ->  format('~nThink of a better administrator key please...~n~n'),
        write(Help_Text),
        halt
    ;   memberchk(key(Key), Opts)        
    ->  file_directory_name(Prog, Dir),
        example_ttl(Dir,Example_TTL),
        instance_ttl(Dir,Instance_TTL),
        instance_hdt(Dir,Instance_HDT),
        md5_hash(Key,Hash,[]),
        atomic_list_concat(['
cp "',Example_TTL,'" "',Instance_TTL,'";
sed -i "s/SEKRET_ADMIN_KEY/',Hash,'/" "',Instance_TTL,'";
rdf2hdt "',Instance_TTL,'" "',Instance_HDT,'";
rm -f "',Instance_HDT,'.index.*";
'],
                           Cmd),
        shell(Cmd),
        format('Successfully updated admin key!!~n'),
        halt
    ;   write(Help_Text),
        halt),

    halt.

    
